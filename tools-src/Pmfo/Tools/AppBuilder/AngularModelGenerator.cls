 
 /*------------------------------------------------------------------------
    File        : AngularModelGenerator
    Purpose     : 
    Syntax      : 
    Description : 
    Author(s)   : hdaniels
    Created     : Sun Jan 24 10:29:38 EST 2021
    Notes       : 
  ----------------------------------------------------------------------*/

using Progress.Lang.*.
using Pmfo.Util.BufferUtil from propath.
using Pmfo.Core.Error.IllegalArgumentError from propath.
using Pmfo.Util.StringUtil from propath.
using OpenEdge.Core.StringConstant from propath.

block-level on error undo, throw.

class Pmfo.Tools.AppBuilder.AngularModelGenerator: 
    define stream codegen. 
    
    define temp-table ttField 
        field handle as handle
        field sortname as character
        field sortseq as integer .
    
    define public property OutputDir as character no-undo get. set.
    
    method public character Generate(pcFolder as character,phBuffer as handle):
        return Generate(pcfolder,phBuffer, "", false).
    end method.
    
    method protected character NumberedSearchable(pcsearchable as character):
        define variable iInt as integer no-undo.
        define variable cSearchable as character no-undo.
        define variable i as integer no-undo.
        define variable cDlm as character no-undo.
      
        do on error undo, throw:
            // if there alreays us a nu,ber then keep as-os
            iInt = integer(entry(1,pcSearchable)).
            // no error means there already is a nunber so just return as-is
            return  pcsearchable. 
            catch e as Progress.Lang.Error :
               // continue processing below 
            end catch.
        end.
        do i = 1 to num-entries(pcsearchable):
            assign
                cSearchable = cSearchable
                            + cDlm 
                            + substitute("&1,&2",i,entry(i,pcsearchable))
                cDlm = ","            
                .                            
        end.
        return cSearchable.
    end.    
    
    method public character Generate(pcfolder as character, phBuffer as handle, pSearchable as character, plFormBuilder as logical):
        define variable iFLd as integer no-undo.
        define variable hFld as handle no-undo.
        define variable cModel as character no-undo.
        define variable iAt as integer no-undo.
        define variable cName as character no-undo.
        define variable cComment as character no-undo.
        define variable iSearch as integer no-undo.
        define variable iSearchNum as integer no-undo.
        define variable iFldSeq as integer no-undo.
        define variable cBaseString as character no-undo.
        define variable cFile as character no-undo.
        pcFolder = replace(pcFolder,StringConstant:BACKSLASH,"/"). 
        pSearchable = NumberedSearchable(pSearchable).
        cModel = BufferUtil:SingularizeSerializeName(phBuffer:serialize-name,true).
        cFile =  subst("&3/&2&1.model.ts",
                       lc(cModel),
                       if Outputdir > "" then left-trim(Outputdir,"/") + "/" else "",
                       pcFolder
                       ).
        output stream codegen to value(cFile).
        
        cBaseString = "BaseModel".
        
        if pSearchable > "" then
        do iFLd = 2 to num-entries(pSearchable) by 2
        on error undo, throw:
           phbuffer:buffer-field(entry(iFld,pSearchable)).
           if index(cBaseString,"Searchable") = 0 then
                cBaseString = cBaseString + ", Searchable".
           catch e as Progress.Lang.Error :
              undo, throw new IllegalArgumentError(subst("Searchable Field '&1' does not exist in '&2'",entry(iFld,pSearchable),phBuffer:name)).     
           end catch.  
        end.
        
        empty temp-table ttField.
        do iFld = 1 to phbuffer:num-fields:
            hfld = phbuffer:buffer-field(iFld). 
            if hFLd:serialize-hidden = false then 
            do:
                
               if hFLd:name = "plant-id" then 
                   cBaseString = cBaseString + ", VaryByPlant".
               if index(hFLd:serialize-name,"@") > 0  and index(cBaseString,"Alias") = 0 then
               do:
                   cBaseString = cBaseString + ", Alias". 
               end.        
               create ttField.
               iFldSeq = 0.
               iFldSeq = int(substr(hFld:serialize-name,length(hFld:serialize-name) - 1)) no-error.
               if iFLdSeq > 0 then 
               do:
                   ttField.sortname = substr(hFld:serialize-name,1,length(hFld:serialize-name) - 2).
                   ttField.sortseq = ifldSeq.
                  
               end.    
               else do: 
                  iFldSeq = int(substr(hFld:serialize-name,length(hFld:serialize-name))) no-error.
                  if iFLdSeq > 0 then 
                  do:
                      ttField.sortname = substr(hFld:serialize-name,1,length(hFld:serialize-name) - 1).
                      ttField.sortseq = ifldSeq.
                
                  end.
                  else
                     ttField.sortname = hFld:serialize-name.
                    
               end.
               ttField.handle = hFld.
            end.
        end.    
        if plFormBuilder then                  
            put stream codegen unformatted 
                "import 骑蝽迈殪溴颥骑蝽蔑铘蝻飕骑蝽球秕 from '@angular/forms';" skip.
        
        put stream codegen unformatted 
           subst("import Ρ from './base.model';",cBaseString) skip.
                
        put stream codegen unformatted skip(1)
             subst("export class &1 extends BaseModel 阃镤屐箅轲篚怏舁Ⅲ翎糸蝈徜镱禊豉疱吾礤Е抱虎郁蜷铉蒸殪禾秣弪冕箦崎蝮舁阃镤屐┅狒箅轲骘遽汨趑崎屐怡箫螋钺礤怡趑崎屐洚箫螋箦窈桄熹趑崎屐洚栳钿戾殒杵啼后弪獒扉瀛栝滗孱驷祗翳孱滹阄犴桄熹后弪獒扉瀛钺礤殒桄熹侯犴痨犷舡殇翳孱滹瘐篝蝈犴泔溴珏箅轲ū┊瘐篝蝈犴泔溴珏躅骘蝽狒翦Ю轴蝙蛮徐犷舁狒泐犴瀹孱洚屐箦滹殒鹩遽蜚栳忪翳孱滹橛遽蜚祜镫躔ㄨ旗浜钺礤鹩遽蜚栳忪濠殒橛遽蜚翳孱滹橛遽蜚栉蹴ㄩ渝狎汨博碑瘐篝蝈犴泔溴珏箅轲ū┊瘐篝蝈犴泔溴珏躅骘蝽狒翦篚怏舁⒗渝狎汨徕戾ěΡКЕ钵Τ迈骀弪蒸殪呵弭崎屐涮徕屐ㄨ旗洎清裟狒嵩疱ㄨ旗浜溽翎豉疱秕麴豸忝镯礤铘┈橛遽蜚栉蹴狒钞孱洚孱洚榱轭溴ㄣ吾礤⒗┊殒榱翳孱滹脲屦腩秣轭泔铙轶趑孱泫骘铒殒痂迈骀弪侯犴Ⅳ粜狎纛弪犷杵熹侯犴⒘沣羯湮犴澧翳孱阄犴篚怏趄ㄣ吾礤爆榱暴汜痼篚怏趄ㄣ吾礤榱爆暴篚怏趄ㄣ吾礤榱博屐箦阄犴迈骀弪蒸殪河轭珲灬蜷逵弪獒扉逦犴濞篚怏趄ㄣ吾礤爆榱暴汜痼篚怏趄ㄣ吾礤榱爆暴篚怏趄ㄣ吾礤榱博瘐篝蝈犴泔溴珏箅轲ū┊瘐篝蝈犴泔溴珏躅骘蝽狒翦篚怏舁⒗领獒蟥Е抱桄熹后弪獒扉瀛钺礤狒泐犴瀹孱洚屐箦瘐篝蝈犴泔溴珏躅骘蝽狒翦阄犴狒钞孱洚瘐篝蝈犴泔溴珏躅骘蝽狒翦⒑清裟狒嵩疱ㄨ旗浜溽翎豉疱秕麴豸忝镯礤铘⒒殒忝镯礤铘翳孱瘐篝蝈犴泔溴珏躅骘蝽狒翦狒蛋忝镯礤铘孱洚孱洚殒痨骑蝽迈殪溴翳孱瘐篝蝈犴泔溴珏躅骘蝽狒翦箅轲ū泸遽翦骑蝽迈殪溴颞驸骑蝽迈殪溴颟狒㈧弭骘蝽球秕铄骑蝽球秕皎┗狒㈡矧戾痱镳轭翳轶狒㈡矧砬蝻躔徜涿镱趄镬痱镳铄骑蝽蔑铘蝻歙翳轶垧蝻疠┅虎狒" at 5
               "return formGroup;" at 5
             "}" at 3.
        
        put stream codegen unformatted skip "}".
        return cfile.
        finally:
            output stream codegen close.        
        end finally.
    end method.
    
    method protected character  GetDataType(pcDataType as character, output pcComment as char):
        case pcDataType :
            when "character" or when "clob" then
               return "string".
            when "integer" or when "int64" then
            do:
               pcComment = pcDataType.
               return "number".         
            end.
            when "decimal" then
               return "number". 
            when "logical" then
               return "boolean". 
            when "date" or when "datetime" or when "datetime-tz" then
               return "Date".
            when "blob" then
            do:
               pcComment = "base64 encode".
               return "string".  // "Blob" ???
            end.     
            otherwise 
               return lc(pcDataType).    
       end case.     
    end method.        
end class.